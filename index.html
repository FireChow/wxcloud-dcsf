<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="shortcut icon"
    href="https://static-index-4gtuqm3bfa95c963-1304825656.tcloudbaseapp.com/official-website/favicon.svg"
    mce_href="https://static-index-4gtuqm3bfa95c963-1304825656.tcloudbaseapp.com/official-website/favicon.svg"
    type="image/x-icon" />
  <meta name="viewport" content="width=650,user-scalable=no" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://weui.io/style/weui.css">
  <title id="title">æ¬¢è¿æ³¨å†Œ</title>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script src="https://web-9gikcbug35bad3a8-1304825656.tcloudbaseapp.com/sdk/1.3.0/cloud.js"></script>
  <script src="https://web-9gikcbug35bad3a8-1304825656.tcloudbaseapp.com/sdk/1.3.1/mplogin.min.js"></script>
  <script>
    window.onload = async function () {
      const result = await window.mplogin({
        scope: "snsapi_userinfo",             // å¿…å¡«ï¼Œç™»å½•æ–¹å¼ï¼šsnsapi_userinfoã€snsapi_base
        appid: 'wx5c88573f4a89192b',           // å¿…å¡«ï¼Œå…¬ä¼—å·appidï¼Œå°†ä»¥æ­¤ appid åä¹‰è¿›è¡Œè¯·æ±‚
        // redirect: '',                      // é€‰å¡«ï¼ŒæˆæƒæˆåŠŸåè·¯ç”±çš„åœ°å€ï¼Œç›®æ ‡åœ°å€åº”èƒ½å¤„ç†æˆæƒå‚æ•°ï¼Œä¸å¡«ä¸ºå½“å‰é¡µé¢
        envid: 'prod-1gyjb4if1998d9b4',              // é€‰å¡«ï¼Œèµ„æºæ–¹å¾®ä¿¡äº‘æ‰˜ç®¡ç¯å¢ƒï¼Œå¦‚æœä¼ é€’æ­¤å‚æ•°åˆ™ä¼šè¿”å›åˆå§‹åŒ–çš„ cloud æ“ä½œå¯¹è±¡
        // resourceAppid: 'wx5c88573f4a89192b',   // é€‰å¡«ï¼Œå¦‚æœæ˜¯èµ„æºå¤ç”¨æ¨¡å¼ï¼Œéœ€è¦å¡«èµ„æºæ–¹å¾®ä¿¡è´¦å·
        // signature: window.location.href       // é€‰å¡«ï¼Œå¦‚æœéœ€è¦å¾®ä¿¡ SDK çš„APIæ–¹æ³•ï¼Œåˆ™å¡«å†™è¦ä½¿ç”¨çš„åœ°å€ï¼Œä¼šè¿”å› signature ç­¾åå¯¹è±¡ï¼Œenvidå‚æ•°ä¸å¡«åˆ™æ— æ•ˆ
        // region: ''                         // é€‰å¡«ï¼Œç¯å¢ƒçš„åœ°åŸŸï¼Œå¯é€‰ap-guangzhouã€ap-beijingï¼Œä¸å¡«é»˜è®¤ä¸ºap-shanghai
        // traceUser:false                    // é€‰å¡«ï¼Œé»˜è®¤trueï¼Œæ˜¯å¦åœ¨å°†ç”¨æˆ·è®¿é—®è®°å½•åˆ°ç”¨æˆ·ç®¡ç†ä¸­ï¼Œéä¸Šæµ·åœ°åŸŸè¯·è®¾ç½®æˆfalse
        noback: true                       // é€‰å¡«ï¼Œé»˜è®¤noback:falseï¼Œæ­¤æ—¶åˆæ¬¡è·³è½¬æˆæƒåï¼Œæ¨¡å—å°†é‡æ–°å›é€€åŠ è½½é¡µé¢ã€‚
      })
      console.log(result)
      if (result.ret === 0) {
        window.app = result.cloud
        init()
      } else {  // retä¸ä¸º0æ—¶ï¼Œä»£è¡¨ç™»å½•å‡ºç°é”™è¯¯ï¼Œä¸€èˆ¬å‡ºç°åœ¨å¼€å‘è°ƒè¯•ä¸­ï¼Œæ­£å¼ä½¿ç”¨ä¸€èˆ¬åªæœ‰2-ç³»ç»Ÿæ‹¦æˆªé”™è¯¯
        // ç™»å½•å‡ºç°é—®é¢˜ï¼Œæ‰“å°é—®é¢˜æè¿°
        window.alert(result.msg)
      }
    }

    async function init() {
      const openid = await callServer('wx_openid')
      if (openid) {
        const user = await callServer(`user/${openid}`)
        if (user.need_improve) {
          window.alert('è¯·å®Œå–„ä¸ªäººä¿¡æ¯')
          window.location.href = './mine.html'
          return
        }
        if (user && user.id) {
          if (user.role === 'admin' || user.role === 'finance') {
            $("#finance").html(`<a href="/users.html">ğŸ‘‰ğŸ» ç”¨æˆ·æŸ¥è¯¢é€šé“ ğŸ‘ˆğŸ»</a>`)
          }
          $(".inputs").css("display", "none")
          $(".pay").css("display", "block")
          $(".loading").css("display", "none")
          $("#title").html('æ‰«ç æ”¯ä»˜')
          $("#invoice").on('click', () => {
            getInvoiceList()
          })
          setTimeout(() => {
            window.alert('ä»˜æ¬¾æ—¶åŠ¡å¿…å¤‡æ³¨å¡«å†™çš„é‰´å®šå¯¹è±¡å’Œç”µè¯')
          }, 500)
        } else {
          $(".inputs").css("display", "block")
          $(".pay").css("display", "none")
          $(".loading").css("display", "none")
          $("#title").html('æ¬¢è¿æ³¨å†Œ')
          registPicker()
          submitRegister()
        }
      } else {
        $(".inputs").css("display", "block")
        $(".pay").css("display", "none")
        $(".loading").css("display", "none")
        $("#title").html('æ¬¢è¿æ³¨å†Œ')
        registPicker()
        submitRegister()
      }
    }

    function submitRegister() {
      $('#js_btn').click(async () => {
        let user = {
          name: $("#name").val().trim(),
          id_tems: $("#id_tems").val().trim(),
          email: $("#email").val().trim(),
          phone: $("#phone").val().trim(),
          referee: $("#referee").val().trim()
        }
        if (!user.name) {
          window.alert('è¯·è¾“å…¥è¢«é‰´å®šå¯¹è±¡ä¿¡æ¯')
          return
        }
        if (!user.id_tems) {
          window.alert('è¯·è¾“å…¥é‰´å®šé¡¹ç›®')
          return
        }
        if (!user.email) {
          window.alert('è¯·è¾“å…¥é‚®ç®±')
          return
        } else if (!/^\w+@\w+\.\w+$/.test(user.email)) {
          window.alert('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±')
          return
        }
        if (!user.phone) {
          window.alert('è¯·è¾“å…¥è”ç³»æ–¹å¼')
          return
        } else if (!/^1[3456789]\d{9}$/.test(user.phone)) {
          window.alert('è¯·è¾“å…¥æ­£ç¡®çš„è”ç³»æ–¹å¼')
          return
        }
        if (!user.referee) {
          window.alert('è¯·è¾“å…¥é‰´å®šäºº')
          return
        }
        $(".inputs").css("display", "none")
        $(".pay").css("display", "none")
        $(".loading").css("display", "block")
        const resUser = await callServer(`user`, 'POST', { user })
        if (resUser && resUser.id) {
          $(".inputs").css("display", "none")
          $(".pay").css("display", "block")
          $(".loading").css("display", "none")
          $("#title").html('æ‰«ç æ”¯ä»˜')
          $("#invoice").on('click', () => {
            getInvoiceList()
          })
          setTimeout(() => {
            window.alert('æ³¨å†ŒæˆåŠŸ, ä»˜æ¬¾æ—¶åŠ¡å¿…å¤‡æ³¨å¡«å†™çš„é‰´å®šå¯¹è±¡å’Œç”µè¯')
          }, 500)
        } else {
          $(".inputs").css("display", "block")
          $(".pay").css("display", "none")
          $(".loading").css("display", "none")
          $("#title").html('æ¬¢è¿æ³¨å†Œ')
        }
      })
    }

    function registPicker() {
      $("#id_items_cell").on('click', () => {
        showPicker()
      })
    }

    function showPicker() {
      weui.picker([{
        label: 'æ³•åŒ»ä¸´åºŠ',
        value: 'æ³•åŒ»ä¸´åºŠ'
      },
      {
        label: 'æ³•åŒ»ç²¾ç¥ç—…',
        value: 'æ³•åŒ»ç²¾ç¥ç—…'
      },
      {
        label: 'æ³•åŒ»ç—…ç†',
        value: 'æ³•åŒ»ç—…ç†'
      },
      {
        label: 'æ³•åŒ»æ¯’ç‰©',
        value: 'æ³•åŒ»æ¯’ç‰©',
      },
      {
        label: 'æ³•åŒ»ç‰©è¯',
        value: 'æ³•åŒ»ç‰©è¯',
      },
      {
        label: 'æ–‡ä¹¦ç—•è¿¹',
        value: 'æ–‡ä¹¦ç—•è¿¹',
      },
      {
        label: 'äº¤é€šäº‹æ•…ç—•è¿¹ç‰©è¯',
        value: 'äº¤é€šäº‹æ•…ç—•è¿¹ç‰©è¯',
      },
      {
        label: 'å£°åƒèµ„æ–™',
        value: 'å£°åƒèµ„æ–™',
      }
      ], {
        defaultValue: ['æ³•åŒ»ä¸´åºŠ'],
        onConfirm: function (result) {
          console.log(result)
          $("#id_tems").val(result)
        }
      })
    }

    async function callServer(path, method = 'GET', data = {}) {
      try {
        const callres = await window.app.callContainer({
          config: {
            env: 'prod-1gyjb4if1998d9b4', // å¾®ä¿¡äº‘æ‰˜ç®¡çš„ç¯å¢ƒID
          },
          path: `/api/${path}`, // å¡«å…¥ä¸šåŠ¡è‡ªå®šä¹‰è·¯å¾„å’Œå‚æ•°ï¼Œæ ¹ç›®å½•ï¼Œå°±æ˜¯ / 
          method: method, // æŒ‰ç…§è‡ªå·±çš„ä¸šåŠ¡å¼€å‘ï¼Œé€‰æ‹©å¯¹åº”çš„æ–¹æ³•
          header: {
            'X-WX-SERVICE': 'koa-7zry', // xxxä¸­å¡«å…¥æœåŠ¡åç§°ï¼ˆå¾®ä¿¡äº‘æ‰˜ç®¡ - æœåŠ¡ç®¡ç† - æœåŠ¡åˆ—è¡¨ - æœåŠ¡åç§°ï¼‰
            "content-type": "application/json"
          },
          data: data
          // å…¶ä½™å‚æ•°åŒ wx.request
        })
        console.log(callres)
        if (callres.data) {
          if (!callres.data.code) {
            return callres.data
          } else if (callres.data.code === 200) {
            return callres.data.data
          } else {
            window.alert(callres.data.errMsg)
          }
        } else {
          window.alert(callres.errMsg)
        }
      } catch (e) {
        console.log(e)
      }
    }

    async function getInvoiceList() {
      let ua = navigator.userAgent.toLowerCase()
      let url = ''
      if (ua.indexOf('micromessenger') !== -1) {
        let isIOS = !!ua.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)
        if (isIOS) {
          url = encodeURIComponent(location.href.split('#')[0])
        } else {
          url = location.href.split('#')[0]
        }
      }
      const data = await window.app.getJSSDKSignature({
        url: url
      })
      wx.config({
        beta: true,//ç”¨äºæ–¹æ³•æœªå¯¹å¤–å…¬å¼€çš„æƒ…å†µ
        debug: false, // å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰apiçš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯alertå‡ºæ¥
        appId: 'wx5c88573f4a89192b', // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
        timestamp: data.timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
        nonceStr: data.nonceStr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
        signature: data.signature,// å¿…å¡«ï¼Œç­¾åï¼Œè§é™„å½•1
        jsApiList: [
          "chooseInvoiceTitle"
        ]
      });
      wx.ready(function () {
        doReady();
      });
      wx.error(function (res) {
        console.log(res, 'å¤±è´¥ï¼')
      });
    }
    function doReady() {
      wx.invoke('chooseInvoiceTitle', {
        "scene": "1"
      }, async (res) => {
        var info = JSON.parse(JSON.stringify(res)).choose_invoice_title_info;
        var infoJ = JSON.parse(JSON.parse(JSON.stringify(info)));
        let invoice = {
          title: infoJ.title,
          tax_number: infoJ.taxNumber,
          company_address: infoJ.companyAddress,
          telephone: infoJ.telephone,
          bank_name: infoJ.bankName,
          bank_account: infoJ.bankAccount,
          type: infoJ.type
        }
        let resInvoice = await callServer('invoice', 'POST', { invoice })
        if (resInvoice.id) {
          window.alert('ç´¢è¦å‘ç¥¨æˆåŠŸï¼Œå‘ç¥¨å°†ç¨åå‘è‡³æ‚¨å¡«å†™çš„é‚®ç®±ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ï¼')
        } else {
          window.alert('ç´¢è¦å‘ç¥¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•')
        }
      })
    }
  </script>
</head>

<body>
  <div>
    <div class="loading" style="margin-top: 80px;width: 100%;text-align: center;">
      <h4>åŠ è½½ä¸­...</h4>
    </div>
    <div class="page form_page js_show inputs" tabindex="-1" style="display: none;">
      <div class="weui-form">
        <div class="weui-form__text-area">
          <h2 class="weui-form__title">æ³¨å†Œ</h2>
          <div class="weui-form__desc">è¯·è¾“å…¥ä»¥ä¸‹ä¿¡æ¯è¿›è¡Œæ³¨å†Œ</div>
        </div>
        <div class="weui-form__control-area">
          <div class="weui-cells__group weui-cells__group_form">
            <div class="weui-cells">
              <label for="js_input1" class="weui-cell weui-cell_active">
                <div class="weui-cell__hd"><span class="weui-label">è¢«é‰´å®šå¯¹è±¡ä¿¡æ¯</span></div>
                <div class="weui-cell__bd">
                  <input id="name" class="weui-input" placeholder="å¡«å†™è¢«é‰´å®šå¯¹è±¡ä¿¡æ¯">
                </div>
              </label>
              <label for="js_input2" id="id_items_cell"
                class="weui-cell weui-cell_active weui-cell_select weui-cell_select-after">
                <div class="weui-cell__hd"><span class="weui-label">é‰´å®šé¡¹ç›®</span></div>
                <div class="weui-cell__bd">
                  <div class="weui-select">
                    <input id="id_tems" class="weui-input" placeholder="è¯·é€‰æ‹©é‰´å®šé¡¹ç›®" disabled>
                  </div>
                </div>
              </label>
              <label for="js_input3" class="weui-cell weui-cell_active">
                <div class="weui-cell__hd"><span class="weui-label">é‚®ç®±</span></div>
                <div class="weui-cell__bd">
                  <input id="email" class="weui-input" placeholder="å¡«å†™é‚®ç®±">
                </div>
              </label>
              <label for="js_input4" class="weui-cell weui-cell_active">
                <div class="weui-cell__hd"><span class="weui-label">è”ç³»æ–¹å¼</span></div>
                <div class="weui-cell__bd">
                  <input id="phone" class="weui-input" placeholder="å¡«å†™è”ç³»æ–¹å¼" type="number" pattern="[0-9]*">
                </div>
              </label>
              <label for="js_input5" class="weui-cell weui-cell_active">
                <div class="weui-cell__hd"><span class="weui-label">é‰´å®šäºº</span></div>
                <div class="weui-cell__bd">
                  <input id="referee" class="weui-input" placeholder="å¡«å†™é‰´å®šäºº">
                </div>
              </label>
            </div>
          </div>
        </div>
        <div class="weui-bottom-fixed-opr" id="js_opr">
          <a href="javascript:;" role="button" class="weui-btn weui-btn_primary" id="js_btn">ç¡®å®š</a>
        </div>
      </div>
    </div>
    <div class="page gallery js_show pay" tabindex="-1" style="display: none;">
      <div class="page__hd">
        <h3 class="page__title" style="text-align: center;">é•¿æŒ‰è¯†åˆ«æ‰«ç æ”¯ä»˜</h3>
      </div>
      <div>
        <img style="width: 100%;"
          src="https://7072-prod-1gyjb4if1998d9b4-1312862016.tcb.qcloud.la/WechatIMG15.jpeg?sign=f5e4f9aa9c0a96080e1e268e031045d6&t=1658386736" />
      </div>
      <div style="text-align: center;">
        <h4 style="color: #F39753;">ä»˜æ¬¾æ—¶åŠ¡å¿…å¤‡æ³¨å¡«å†™çš„é‰´å®šå¯¹è±¡å’Œç”µè¯</h4>
        <div><a href="/mine.html">å¿˜è®°äº†é‰´å®šä¿¡æ¯ï¼Ÿç‚¹è¿™é‡ŒæŸ¥çœ‹æˆ–ä¿®æ”¹</a></div>
        <div style="margin-top: 10px;"><a href="javascript:;" id="invoice">æˆ‘å·²æ”¯ä»˜ï¼Œè¦å¼€å‘ç¥¨ï¼Ÿæˆ³è¿™é‡ŒğŸ‘ˆğŸ»</a></div>
        <div id="finance" style="margin-top: 10px;"></div>
      </div>
    </div>
  </div>
</body>
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://res.wx.qq.com/t/wx_fed/cdn_libs/res/weui/1.2.8/weui.min.js"></script>
<script>

</script>

</html>